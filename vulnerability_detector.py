#!/usr/bin/python3
import argparse
from argparse import RawTextHelpFormatter
import pattern
import analyze
from ast_parser import *
from analyzer import *
import os

def main():

    description = 'Vulnerability Detector\n'

    usage = '\n\
    vulnerability_detector <sliceJSON> <patternsJSON>\n'

    parser = argparse.ArgumentParser(prog='vulnerability_detector', description=description,
                                     usage=usage, formatter_class=RawTextHelpFormatter)
    parser.add_argument('sliceJSON', type=str)
    parser.add_argument('patternsJSON', type=str)

    args = parser.parse_args()

    with open(args.patternsJSON, "r") as json_pattern_file:
        pattern_list = pattern.parse(json_pattern_file)

    with open(args.sliceJSON, "r") as json_slice_file:
        ast_parser = AstParser()
        ast_tree = ast_parser.parse(json_slice_file)

        analyzer = Analyzer(pattern_list)
        ast_tree.get_analyzed(analyzer)

        print("\nvar levels: {}\n".format(analyzer.decl_vars))
        print("vulnerabilities basic: {}\n".format(analyzer.basic_vulnerabilities))
        print("vulnerabilities advanced: {}\n".format(analyzer.advanced_vulnerabilities))

    if not os.path.exists('output'):
        os.makedirs('output')
    output_file_name = 'output/'+os.path.splitext(os.path.basename(args.sliceJSON))[0]+'.output.json'
    f = open(output_file_name, "w")
    f.write(json.dumps(analyzer.basic_vulnerabilities, indent=4))
    f.close()

    advanced_output_file_name = 'output/'+os.path.splitext(os.path.basename(args.sliceJSON))[0]+'.advanced.output.json'
    f = open(advanced_output_file_name, "w")
    f.write(json.dumps(analyzer.advanced_vulnerabilities, indent=4))
    f.close()

if __name__ == "__main__":
    main()